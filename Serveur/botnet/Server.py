import socket
import time
import base64
import os
import threading
import colorama
import random


class Server:
    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.server_socket = None
        self.clients = []
        self.running = False

    def clear(self):
        if os.name == "nt":
            os.system("cls")
        else:
            os.system("clear")

    def mainMenu(self):
        self.clear()
        while True:
            print("Welcome to the server")
            print("1. Start Server")
            print("2. Stop Server")
            print("3. Display Connected Clients")
            print("4. Send Message to all clients")
            print("0. Exit")
            try:
                choice = int(input("Enter your choice: "))
                if choice == 1:
                    self.start_server()
                elif choice == 2:
                    self.stop_server()
                elif choice == 3:
                    self.display_clients()
                elif choice == 4:
                    if not self.running:
                        print("Server is not running")
                    else:
                        message = input("Enter your message: ")
                        for client in self.clients:
                            client.send(message.encode())
                elif choice == 0:
                    break
                    exit()
                else:
                    print("Invalid choice")
            except ValueError:
                print("Invalid choice")
            except KeyboardInterrupt:
                # Gracefully stop the server on keyboard interrupt (e.g., Ctrl+C)
                self.stop_server()
                break

    def socketServer(self):  # Create a socket server
        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.server_socket.bind((self.host, self.port))
        self.server_socket.listen(1)
        print(f"Waiting connections on {self.host}:{self.port}")

    def display_clients(self):  # Display connected clients
        menu = """
+-----------+
| Clients : |
+-----------+
        """
        self.clear()
        if not self.running:
            print("Server is not running")
        else:
            pass
        if not self.clients:
            print("No clients connected")
        else:
            print(menu)
            for i, client in enumerate(self.clients, 1):
                clientAddress = client.getpeername()
                print(f"[{i}] - {clientAddress}")
        input("Press enter to go back to the main menu")
        self.mainMenu()

    def handle_connection(self, client, clientAddress):  # Handle client connection
        # print(f"Connection from {clientAddress}")
        self.clients.append(client)
        time.sleep(3)
        try:
            while True:
                data = client.recv(1024)
                if not data:
                    # If the data is empty, the client has closed the connection
                    break
        except Exception as e:
            print(f"Error while receiving data: {e}")
        finally:
            # Close the client socket when done
            print(f"{clientAddress} Log-out")
            client.close()
            self.clients.remove(client)

    def start_server(self):  # Start the server
        if not self.running:
            self.socketServer()
            self.running = True
            server_thread = threading.Thread(
                target=self.listen_for_connections)
            server_thread.start()

    def listen_for_connections(self):  # Listen for client connections
        while self.running:
            try:
                client, clientAddress = self.server_socket.accept()
                # Start a new thread to handle the connection
                connection_thread = threading.Thread(
                    target=self.handle_connection, args=(client, clientAddress))
                connection_thread.start()
            except KeyboardInterrupt:
                # Gracefully stop the server on keyboard interrupt (e.g., Ctrl+C)
                self.running = False
                self.server_socket.close()

    def stop_server(self):  # Stop the server
        if self.running:
            # Use this method to stop the server gracefully
            self.running = False
            if self.server_socket:
                self.server_socket.close()
                self.server_socket = None


serv = Server("192.168.1.1", 1337)
serv.mainMenu()
